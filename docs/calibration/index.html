<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/Robyn/blog/rss.xml" title="Robyn Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Robyn/blog/atom.xml" title="Robyn Blog Atom Feed"><title data-react-helmet="true">Calibration using experimental results | Robyn</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Calibration using experimental results | Robyn"><meta data-react-helmet="true" name="description" content="Calibration concept"><meta data-react-helmet="true" property="og:description" content="Calibration concept"><meta data-react-helmet="true" property="og:url" content="https://facebookexperimental.github.io/Robyn//Robyn/docs/calibration"><link data-react-helmet="true" rel="shortcut icon" href="/Robyn/img/robyn_logo.png"><link data-react-helmet="true" rel="canonical" href="https://facebookexperimental.github.io/Robyn//Robyn/docs/calibration"><link rel="stylesheet" href="/Robyn/styles.4eedf040.css">
<link rel="preload" href="/Robyn/styles.98a00bbb.js" as="script">
<link rel="preload" href="/Robyn/runtime~main.60ee2165.js" as="script">
<link rel="preload" href="/Robyn/main.a064c0c0.js" as="script">
<link rel="preload" href="/Robyn/1.ce9e6ffa.js" as="script">
<link rel="preload" href="/Robyn/18.641f941c.js" as="script">
<link rel="preload" href="/Robyn/19.1571ad29.js" as="script">
<link rel="preload" href="/Robyn/935f2afb.7aa0c430.js" as="script">
<link rel="preload" href="/Robyn/17.e44ce4e8.js" as="script">
<link rel="preload" href="/Robyn/8f394379.719ba5ea.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/Robyn/"><img src="/Robyn/img/robyn_logo.png" alt="Robyn Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Robyn/img/robyn_logo.png" alt="Robyn Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Robyn</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Robyn/docs/">Docs</a><a class="navbar__item navbar__link" href="/Robyn/docs/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookexperimental/Robyn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/Robyn/"><img src="/Robyn/img/robyn_logo.png" alt="Robyn Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Robyn/img/robyn_logo.png" alt="Robyn Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Robyn</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/Robyn/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/Robyn/docs/about">About</a></li><li class="menu__list-item"><a href="https://github.com/facebookexperimental/Robyn" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">How-to guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Robyn/docs/">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Robyn/docs/quick-start">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Robyn/docs/step-by-step-guide">Step-by-step guide</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/ridge-regression">Ridge Regression</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/variable-transformations">Variable Transformations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/facebook-prophet">Facebook Prophet - Trend, Seasonality and Holiday Effects</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/automated-hyperparameter-selection-optimization">Automated hyperparameter selection and optimization</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/Robyn/docs/calibration">Calibration using experimental results</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/outputs-diagnostics">Outputs and diagnostics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/contributing">Getting help and contributing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Robyn/docs/about">About Robyn</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Calibration using experimental results</h1></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="calibration-concept"></a>Calibration concept<a class="hash-link" href="#calibration-concept" title="Direct link to heading">#</a></h3><p>By applying results from randomized controlled-experiments, you may improve the
accuracy of your marketing mix models dramatically. It is recommended to run
these on a recurrent basis to keep the model calibrated permanently. In general,
we want to compare the experiment result with the MMM estimation of a marketing
channel. Conceptually, this method is like a Bayesian method, in which we use
experiment results as a prior to shrink the coefficients of media variables. A
good example of these types of experiments is Facebookâ€™s conversion lift tool
which can help guide the model towards a specific range of incremental values.</p><img alt="Calibration chart" src="/Robyn/img/calibration1.png"><p>Figure illustrates the calibration process above for one MMM candidate model.
Table below illustrates the model selection output including FB lift calibration
element. Modelers can select the top models with relatively small MAPE metrics
as the candidates for the final model. In this example, we suggest picking model
two, as it has the minimum <em>MAPE(cal,fb)</em> and its <em>MAPE(holdout)</em>
is only 0.4% more than the minimum one.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="example-table"></a>Example Table<a class="hash-link" href="#example-table" title="Direct link to heading">#</a></h4><p>Sample output of model selection of a MMM with only two media channels, TV and
Social <img alt="Calibration table" src="/Robyn/img/calibration2.png"></p><p>Note that <em>MAPE(cal,fb)</em> will likely vary more widely than</p><em>MAPE(holdout)</em> . Given this, calibration can improve performance without substantially sacrificing backtesting performance. This calibration method can be applied to other media channels which run experiments, the more channels that are calibrated, the more accurate the MMM model. <em>You may find the calibration function in the â€˜func.Râ€™ script.</em><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="calibration-in-the-code"></a>Calibration in the code<a class="hash-link" href="#calibration-in-the-code" title="Direct link to heading">#</a></h3><p>So, how do we apply this in our code?</p><ol><li>First, we check if media channels to be calibrated actually have a media
variable created.</li><li>After that, we collect all different media to be calibrated. Consequently, we
loop over each lift channel (Where for each of them we iterate over all
different studies if more than one, determining the date range of each study)</li><li>In addition, we convert data from weeks to days (Please note the *7 in the
formula for mmmDays, this is assuming you will use weekly data as a basis for
your model).</li><li>Finally, and once both lift study and MMM dates are both in days, we scale
the total decomposed model predicted sales into the exact number of days the
lift study had to be comparable with previously uploaded liftAbs number under
the set_lift variable (remember liftAbs values in set_lift variable have to
be absolute and measuring the same metric as the model does ie. total
incremental sales vs. model predicted sales)</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#### Define lift calibration function</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">f.calibrateLift &lt;- function(decompCollect, set_lift) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  check_set_lift &lt;- any(sapply(set_lift$channel, function(x) any(str_detect(x, set_mediaVarName)))==F) #check if any lift channel doesn&#x27;t have media var</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (check_set_lift) {stop(&quot;set_lift channels must have media variable&quot;)}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ## prep lift input</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  getLiftMedia &lt;- unique(set_lift$channel)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  getDecompVec &lt;- decompCollect$xDecompVec</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ## loop all lift input</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  liftCollect &lt;- list()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  for (m in 1:length(getLiftMedia)) { # loop per lift channel</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    liftWhich &lt;- str_which(set_lift$channel, getLiftMedia[m])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    liftCollect2 &lt;- list()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (lw in 1:length(liftWhich)) { # loop per lift test per channel</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ## get lift period subset</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftStart &lt;- set_lift[liftWhich[lw], liftStartDate]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftEnd &lt;- set_lift[liftWhich[lw], liftEndDate]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftPeriodVec &lt;- getDecompVec[DS &gt;= liftStart &amp; DS &lt;= liftEnd, c(&quot;DS&quot;, getLiftMedia[m]), with = F]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ## scale decomp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      mmmDays &lt;- nrow(liftPeriodVec) * 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftDays &lt;- as.integer(liftEnd- liftStart + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      y_hatLift &lt;- sum(unlist(getDecompVec[, -1])) # total pred sales</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      x_decompLift &lt;- sum(liftPeriodVec[,2])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      x_decompLiftScaled &lt;- x_decompLift / mmmDays * liftDays</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ## output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      liftCollect2[[lw]] &lt;- data.table(liftMedia = getLiftMedia[m] ,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       liftStart = liftStart,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       liftEnd = liftEnd,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       liftAbs = set_lift[liftWhich[lw], liftAbs],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       decompAbsScaled = x_decompLiftScaled)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    liftCollect[[m]] &lt;- rbindlist(liftCollect2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The last step is to calculate the MAPE. This will be the key metric to define
the model that is closest to actual incremental sales during periods for the
lift study. It will therefore allow us to make a decision as per the example on
the <a href="#example-table"><strong>table</strong></a>.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ## get mape_lift</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  liftCollect &lt;- rbindlist(liftCollect)[, mape_lift := abs((decompAbsScaled - liftAbs) / liftAbs) * 100]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return(liftCollect)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebookexperimental/Robyn/docs/calibration.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Robyn/docs/automated-hyperparameter-selection-optimization"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Automated hyperparameter selection and optimization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Robyn/docs/outputs-diagnostics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Outputs and diagnostics Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#calibration-concept" class="table-of-contents__link">Calibration concept</a></li><li><a href="#calibration-in-the-code" class="table-of-contents__link">Calibration in the code</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebookexperimental/Robyn" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_31Aa"><img class="footer__logo" alt="Facebook Open Source Logo" src="/Robyn/img/oss_logo.png"></a></div><div class="footer__copyright">Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/Robyn/styles.98a00bbb.js"></script>
<script src="/Robyn/runtime~main.60ee2165.js"></script>
<script src="/Robyn/main.a064c0c0.js"></script>
<script src="/Robyn/1.ce9e6ffa.js"></script>
<script src="/Robyn/18.641f941c.js"></script>
<script src="/Robyn/19.1571ad29.js"></script>
<script src="/Robyn/935f2afb.7aa0c430.js"></script>
<script src="/Robyn/17.e44ce4e8.js"></script>
<script src="/Robyn/8f394379.719ba5ea.js"></script>
</body>
</html>